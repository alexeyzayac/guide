# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"

  # Отключаем автоматическую замену SSH-ключей (повышает стабильность)
  config.ssh.insert_key = false

  # Проброс портов
  config.vm.network "forwarded_port", guest: 80, host: 8000
  config.vm.network "forwarded_port", guest: 443, host: 8443

  # Приватная сеть с фиксированным IP
  config.vm.network "private_network", ip: "192.168.56.10"

  # Настройки VirtualBox
  config.vm.provider "virtualbox" do |vb|
    vb.name = "nginx-vm"
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Настройки vagrant-vbguest (автообновление гостевых дополнений)
  config.vbguest.auto_update = true
  config.vbguest.no_install = false
  config.vbguest.no_remote = false
  config.vbguest.auto_reboot = true
  # Явно указываем источник ISO (можно закомментировать, если доверяете автоматике)
  config.vbguest.iso_path = "https://download.virtualbox.org/virtualbox/%{version}/VBoxGuestAdditions_%{version}.iso"

  # Провижинер для обновления системы и установки необходимых пакетов
  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    apt-get dist-upgrade -y
    # Устанавливаем метапакет заголовков ядра (всегда под актуальное ядро) и инструменты сборки
    apt-get install -y linux-headers-generic build-essential python3 python3-pip
    # Устанавливаем nginx и zabbix-агент
    apt-get install -y nginx
  SHELL

  # Провижинер Ansible (запускается внутри гостевой системы)
  config.vm.provision "ansible_local" do |ansible|
    ansible.playbook = "playbook.yml"
    ansible.verbose = "vv"
  end
end